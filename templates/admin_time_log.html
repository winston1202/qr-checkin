{% extends "admin_layout.html" %}

{% block title %}Time Clock Log{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-md">
<!-- In templates/admin_time_log.html -->

<!-- Filter Form -->
<form method="GET" action="{{ url_for('admin_time_log') }}" class="mb-6 pb-6 border-b">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
        <div>
            <label for="nameFilter" class="block text-sm font-medium text-gray-700">Filter by Name</label>
            <select name="name" id="nameFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                <option value="">All Names</option>
                
                <!--
                  ===============================================================
                  == THIS IS THE CLEANEST, EDITOR-FRIENDLY FIX ================
                  ===============================================================
                  1. Loop through each name.
                  2. Set a variable 'is_selected' BEFORE the <option> tag.
                  3. Simply print the 'is_selected' variable inside the tag.
                  This separates the logic from the HTML, which makes the syntax
                  highlighter happy and removes the red highlighting.
                -->
                {% for name in unique_names %}
                    {% set is_selected = 'selected' if name == filter_name else '' %}
                    <option value="{{ name }}" {{ is_selected }}>
                        {{ name }}
                    </option>
                {% endfor %}

            </select>
        </div>
        <div>
            <label for="dateFilter" class="block text-sm font-medium text-gray-700">Filter by Date</label>
            <input type="date" name="date" id="dateFilter" value="{{ filter_date }}" class="mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
        </div>
        <div class="flex flex-wrap gap-2">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Filter</button>
            <a href="{{ url_for('admin_time_log') }}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">Clear</a>
        </div>
    </div>
</form>

    <!-- Log Table -->
    <div class="overflow-x-auto">
        <table class="w-full text-left text-sm min-w-[600px]">
            <!-- Table content is unchanged -->
            <thead>
                <tr class="border-b"><th class="py-2">Name</th><th class="py-2">Date</th><th class="py-2">Clock In</th><th class="py-2">Clock Out</th><th class="py-2">Action</th></tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-2">{{ log['Name'] }}</td><td class="py-2">{{ log['Date'] }}</td><td class="py-2">{{ log['Clock In'] }}</td><td class="py-2">{{ log['Clock Out'] }}</td>
                    <td class="py-2">
                        <form action="{{ url_for('delete_log_entry', row_id=log.row_id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this entire time entry?');">
                            <button type="submit" class="text-red-500 hover:text-red-700 text-xs font-semibold">DELETE</button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="py-4 text-center text-gray-500">No records found for the selected filters.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- =============================================================== -->
<!-- == NEW EXPORT MODAL (MINI WINDOW) ============================= -->
<!-- =============================================================== -->
<div id="exportModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden">
    <div class="relative mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Choose Export Format</h3>
            <div class="mt-4 px-7 py-3 space-y-3">
                <button id="exportCsvBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Export as CSV</button>
                <button id="exportPdfBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Save as PDF</button>
                <button id="printBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Print on Printer</button>
            </div>
            <div class="items-center px-4 py-3">
                <button id="closeModalBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 w-full">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Get references to all the modal elements
    const exportBtn = document.getElementById('exportBtn');
    const exportModal = document.getElementById('exportModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const printBtn = document.getElementById('printBtn');

    // Function to get current filter values
    function getFilterParams() {
        const name = document.getElementById('nameFilter').value;
        const date = document.getElementById('dateFilter').value;
        return new URLSearchParams({ name, date }).toString();
    }

    // Show the modal when the main export button is clicked
    exportBtn.addEventListener('click', () => {
        exportModal.classList.remove('hidden');
    });

    // Hide the modal when the cancel button is clicked
    closeModalBtn.addEventListener('click', () => {
        exportModal.classList.add('hidden');
    });

    // Handle CSV export
    exportCsvBtn.addEventListener('click', () => {
        const params = getFilterParams();
        window.location.href = `{{ url_for('export_csv') }}?${params}`;
        exportModal.classList.add('hidden');
    });

    // Handle PDF export (opens the print view in a new tab)
    exportPdfBtn.addEventListener('click', () => {
        const params = getFilterParams();
        window.open(`{{ url_for('admin_print_view') }}?${params}`, '_blank');
        exportModal.classList.add('hidden');
    });

    // Handle Printing (opens the print view in a new tab)
    printBtn.addEventListener('click', () => {
        const params = getFilterParams();
        window.open(`{{ url_for('admin_print_view') }}?${params}`, '_blank');
        exportModal.classList.add('hidden');
    });

</script>
{% endblock %}