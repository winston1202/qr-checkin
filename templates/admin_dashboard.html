{% extends "admin_layout.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-md">
    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Currently Clocked In</h2>
    
    <div id="currently-in-container">
        <!-- This is a placeholder that will be filled by JavaScript -->
        {% if currently_in %}
            <div class="overflow-x-auto">
                <table class="w-full text-left min-w-[500px]">
                    <thead>
                        <tr>
                            <th class="py-2">Name</th>
                            <th class="py-2">Clock In Time</th>
                            <th class="py-2">Action</th>
                        </tr>
                    </thead>
                    <!-- We give the tbody an ID so our JavaScript can easily target it -->
                    <tbody id="currently-in-tbody">
                        {% for person in currently_in %}
                        <tr class="border-t">
                            <td class="py-3 font-semibold">{{ person['Name'] }}</td>
                            <td class="py-3 text-gray-600">{{ person['Clock In'] }}</td>
                            <td class="py-3">
                                <form action="{{ url_for('fix_clock_out', row_id=person.row_id) }}" method="POST">
                                    <input type="hidden" name="name" value="{{ person['Name'] }}">
                                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-3 rounded">
                                        Clock Out Now
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <p id="no-one-in-message" class="text-gray-600">No one is currently clocked in.</p>
        {% endif %}
    </div>
</div>

<!-- =============================================================== -->
<!-- == NEW REAL-TIME UPDATE SCRIPT ================================ -->
<!-- =============================================================== -->
<script>
    // This function fetches new data and updates the table
    async function updateDashboard() {
        try {
            const response = await fetch("{{ url_for('admin_api_dashboard_data') }}");
            if (!response.ok) {
                console.error("Failed to fetch dashboard data");
                return;
            }
            const people = await response.json();
            
            const tbody = document.getElementById('currently-in-tbody');
            const container = document.getElementById('currently-in-container');

            // Clear the current table body
            if (tbody) {
                tbody.innerHTML = '';
            }

            if (people.length > 0) {
                // If there are people clocked in, build the table rows
                let tableHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[500px]">
                            <thead><tr><th class="py-2">Name</th><th class="py-2">Clock In Time</th><th class="py-2">Action</th></tr></thead>
                            <tbody id="currently-in-tbody">`;
                
                people.forEach(person => {
                    tableHTML += `
                        <tr class="border-t">
                            <td class="py-3 font-semibold">${person.Name}</td>
                            <td class="py-3 text-gray-600">${person['Clock In']}</td>
                            <td class="py-3">
                                <form action="/admin/fix_clock_out/${person.row_id}" method="POST">
                                    <input type="hidden" name="name" value="${person.Name}">
                                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-3 rounded">
                                        Clock Out Now
                                    </button>
                                </form>
                            </td>
                        </tr>`;
                });

                tableHTML += `</tbody></table></div>`;
                container.innerHTML = tableHTML;

            } else {
                // If no one is clocked in, show the message
                container.innerHTML = '<p id="no-one-in-message" class="text-gray-600">No one is currently clocked in.</p>';
            }

        } catch (error) {
            console.error("Error updating dashboard:", error);
        }
    }

    // When the page loads, call the update function immediately,
    // and then set it to run again every 15 seconds (15000 milliseconds)
    document.addEventListener('DOMContentLoaded', () => {
        updateDashboard(); // Initial load
        setInterval(updateDashboard, 15000); // Poll every 15 seconds
    });
</script>
{% endblock %}